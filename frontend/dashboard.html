<!doctype html>
<html>

<head>
    <meta charset="utf-8" />
    <title>Amanicare — Clinic Summary Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        .card {
            max-width: 1100px;
            margin: 20px auto;
        }

        .small-muted {
            color: #666;
            font-size: .9rem;
        }

        .badge-normal {
            background: #198754;
            color: white;
        }

        .badge-abnormal {
            background: #dc3545;
            color: white;
        }

        pre.payload {
            background: #f8f9fa;
            padding: 8px;
            border-radius: 6px;
            white-space: pre-wrap;
        }
    </style>
</head>

<body>
    <div class="card p-4">
        <h3>Amanicare — Clinic Summary Dashboard</h3>
        <p class="small-muted">Aggregated abnormal rates per clinic (recent window).</p>

        <div class="row g-2 align-items-center mb-3">
            <div class="col-auto">
                <label class="form-label">Window (hours)</label>
                <input id="hours" class="form-control" value="24" type="number" min="1" style="width:120px">
            </div>
            <div class="col-auto">
                <label class="form-label">&nbsp;</label>
                <button id="btnLoad" class="btn btn-primary d-block">Load Summary</button>
            </div>
            <div class="col-auto ms-auto text-end">
                <div class="small-muted">API: <code>/results/summary?hours=...</code></div>
            </div>
        </div>

        <div id="summaryArea">
            <div class="text-muted">Press <strong>Load Summary</strong> to fetch data from the inference node.</div>
        </div>

        <!-- New: Latest explanation quick panel -->
        <div id="latestExplanation" class="mt-2 mb-3" style="max-width:1100px;margin:0 auto;"></div>

        <hr>

        <div id="alertArea" class="mb-2"></div>

        <div class="row">
            <div class="col-md-6">
                <h6>Clinic table</h6>
                <div id="tableArea" style="max-height:320px; overflow:auto"></div>

                <!-- Drill-down details area -->
                <div id="detailsArea" class="mt-3" style="max-height:260px; overflow:auto; font-size:0.95rem;"></div>
            </div>

            <div class="col-md-6">
                <h6>Abnormal rate chart</h6>
                <canvas id="chart" style="max-height:320px"></canvas>
            </div>
        </div>

        <div class="mt-3 small-muted">Note: Data is generated from <code>/results</code> table. Ensure the inference
            service is running at the same host.</div>
    </div>

    <script>
        (() => {
            if (window.__AMANICARE_INIT) {
                console.log("[AMANICARE] script already initialized — skipping.");
                return;
            }
            window.__AMANICARE_INIT = true;

            const API_BASE = ""; // same-origin, works when served by FastAPI /static
            let chartInstance = null;
            const ALERT_THRESHOLD = 0.20; // 20% threshold for visible alert

            function showAlert(msg, level = "danger") {
                const el = document.getElementById("alertArea");
                if (!el) return;
                el.innerHTML = `<div class="alert alert-${level} py-2">${msg}</div>`;
            }
            function clearAlert() {
                const el = document.getElementById("alertArea"); if (el) el.innerHTML = "";
            }

            // render table with clickable clinic links
            function renderTable(clinics) {
                try {
                    const area = document.getElementById("tableArea");
                    if (!area) { console.warn("[AMANICARE] tableArea not found"); return; }
                    if (!clinics || clinics.length === 0) {
                        area.innerHTML = '<div class="small-muted">No clinic data in the selected window.</div>';
                        return;
                    }
                    let html = `<table class="table table-sm table-hover">
            <thead><tr><th>Clinic</th><th>Total</th><th>Abnormal</th><th>Abnormal rate</th></tr></thead><tbody>`;
                    clinics.forEach(c => {
                        html += `<tr>
              <td><a href="#" class="clinic-link" data-clinic="${c.clinic_id}">${c.clinic_id}</a></td>
              <td>${c.total}</td>
              <td>${c.abnormal}</td>
              <td>${(c.abnormal_rate * 100).toFixed(1)}%</td>
            </tr>`;
                    });
                    html += `</tbody></table>`;
                    area.innerHTML = html;

                    // attach click handlers
                    document.querySelectorAll('.clinic-link').forEach(btn => {
                        btn.addEventListener('click', (ev) => {
                            ev.preventDefault();
                            const cid = btn.dataset.clinic;
                            if (cid) loadClinic(cid);
                        });
                    });
                } catch (err) {
                    console.error("[AMANICARE] renderTable error:", err);
                }
            }

            // chart that renders 0% as tiny visible bar and real percent in tooltip
            function renderChart(clinics) {
                try {
                    const canvas = document.getElementById('chart'); if (!canvas) return;
                    const ctx = canvas.getContext('2d'); if (!ctx) return;
                    if (chartInstance) { try { chartInstance.destroy(); } catch (e) { } chartInstance = null; }

                    if (!clinics || clinics.length === 0) {
                        chartInstance = new Chart(ctx, {
                            type: 'bar',
                            data: { labels: ['no data'], datasets: [{ label: 'Abnormal rate', data: [0.01] }] },
                            options: { scales: { y: { beginAtZero: true, max: 1 } } }
                        });
                        return;
                    }

                    const labels = clinics.map(c => c.clinic_id);
                    const trueValues = clinics.map(c => (typeof c.abnormal_rate === 'number' ? c.abnormal_rate : 0));
                    const visibleValues = trueValues.map(v => v === 0 ? 0.01 : v);
                    const backgroundColors = trueValues.map(v => v === 0 ? 'rgba(108,117,125,0.6)' : 'rgba(220,53,69,0.9)');

                    chartInstance = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels,
                            datasets: [{
                                label: 'Abnormal rate (0–1)',
                                data: visibleValues,
                                actualData: trueValues,
                                backgroundColor: backgroundColors
                            }]
                        },
                        options: {
                            indexAxis: 'y',
                            scales: {
                                x: { beginAtZero: true, max: 1, ticks: { callback: v => (v * 100) + '%' } }
                            },
                            plugins: {
                                legend: { display: false },
                                tooltip: {
                                    callbacks: {
                                        label: function (context) {
                                            const actual = context.dataset.actualData ? context.dataset.actualData[context.dataIndex] : context.parsed.x;
                                            return 'Abnormal rate: ' + (actual * 100).toFixed(1) + '%';
                                        }
                                    }
                                }
                            }
                        }
                    });
                } catch (err) {
                    console.error("[AMANICARE] renderChart error:", err);
                }
            }

            // fetch summary and update UI
            async function loadSummary() {
                console.log("[AMANICARE] loadSummary start");
                const hours = Number(document.getElementById('hours').value) || 24;
                const area = document.getElementById('summaryArea');
                if (area) area.innerHTML = 'Loading summary…';
                try {
                    clearAlert();
                    const res = await fetch(`${API_BASE}/results/summary?hours=${hours}`);
                    console.log("[AMANICARE] fetch status", res.status);
                    if (!res.ok) throw new Error('HTTP ' + res.status);
                    const body = await res.json();
                    const clinics = body.clinics || [];
                    if (area) area.innerHTML = `<div class="small-muted">Window: last ${body.window_hours} hours — Clinics: ${clinics.length}</div>`;

                    // show alert if any clinic above threshold
                    const risky = clinics.find(c => (c.abnormal_rate || 0) >= ALERT_THRESHOLD);
                    if (risky) {
                        showAlert(`ALERT: ${risky.clinic_id} has abnormal rate ${(risky.abnormal_rate * 100).toFixed(1)}% (threshold ${(ALERT_THRESHOLD * 100).toFixed(0)}%)`, "danger");
                    } else {
                        clearAlert();
                    }

                    renderTable(clinics);
                    setTimeout(() => renderChart(clinics), 120);

                    // update latest explanation panel
                    await renderLatestExplanation();

                    console.log("[AMANICARE] loadSummary done");
                } catch (err) {
                    console.error("[AMANICARE] loadSummary ERROR:", err);
                    if (area) area.innerHTML = `<div class="text-danger">Failed to load: ${err}</div>`;
                    renderTable([]);
                    try { renderChart([]); } catch (e) { }
                }
            }

            // load recent records for a clinic and show details
            async function loadClinic(clinic_id, limit = 10) {
                const details = document.getElementById('detailsArea');
                if (details) details.innerHTML = `<div class="small-muted">Loading recent records for ${clinic_id}…</div>`;
                try {
                    const res = await fetch(`${API_BASE}/results?clinic_id=${encodeURIComponent(clinic_id)}&limit=${limit}`);
                    if (!res.ok) throw new Error('HTTP ' + res.status);
                    const body = await res.json();
                    const rows = body.results || [];
                    if (!details) return;
                    if (rows.length === 0) {
                        details.innerHTML = `<div class="small-muted">No recent records for ${clinic_id}</div>`;
                        return;
                    }
                    let html = `<div><strong>Recent records — ${clinic_id}</strong></div><div class="list-group mt-2">`;
                    rows.forEach(r => {
                        const payload = JSON.stringify(r.payload, null, 2);
                        const explanation = (r.explanation || []).map(e => `${e.feature}:${e.value}`).join(", ");
                        html += `<div class="list-group-item">
              <div><small class="text-muted">${r.ts}</small></div>
              <div><strong>Anomaly:</strong> ${r.anomaly ? '<span class="badge badge-abnormal">Yes</span>' : '<span class="badge badge-normal">No</span>'} 
                &nbsp; <strong>Score:</strong> ${(r.score || 0).toFixed(3)}</div>
              <div><strong>Top:</strong> ${explanation}</div>
              <pre class="payload">${payload}</pre>
            </div>`;
                    });
                    html += `</div>`;
                    details.innerHTML = html;

                    // refresh latest explanation panel as well
                    renderLatestExplanation();
                } catch (err) {
                    console.error("[AMANICARE] loadClinic ERROR:", err);
                    if (details) details.innerHTML = `<div class="text-danger">Failed to load clinic records: ${err}</div>`;
                }
            }

            // show most recent anomalous record and explanation (visible panel)
            async function renderLatestExplanation() {
                const el = document.getElementById("latestExplanation");
                if (!el) return;
                el.innerHTML = '<div class="small-muted">Loading latest explanation…</div>';
                try {
                    const res = await fetch(`${API_BASE}/results?limit=40`);
                    if (!res.ok) throw new Error('HTTP ' + res.status);
                    const body = await res.json();
                    const rows = body.results || [];
                    // find most recent anomaly
                    const anomaly = rows.find(r => r.anomaly) || null;
                    if (!anomaly) {
                        el.innerHTML = `<div class="alert alert-secondary py-2">No recent anomalies detected in the fetched window.</div>`;
                        return;
                    }
                    const top = (anomaly.explanation || []).map(e => `<strong>${e.feature}</strong>: ${e.value} (z ${e.z})`).join(" &nbsp; • &nbsp; ");
                    el.innerHTML = `
            <div class="alert alert-warning py-2">
              <div><strong>Latest Anomaly</strong> — Clinic: <strong>${anomaly.clinic_id}</strong> • ${anomaly.ts}</div>
              <div class="mt-1"><small>Score: ${Number(anomaly.score || 0).toFixed(3)}, Isolation: ${Number(anomaly.iso_score || 0).toFixed(3)}</small></div>
              <div class="mt-2"><em>Top features:</em> ${top}</div>
            </div>
          `;
                } catch (err) {
                    console.error("renderLatestExplanation error:", err);
                    el.innerHTML = `<div class="text-danger">Failed to load latest explanation: ${err}</div>`;
                }
            }

            // bind UI
            const loadBtn = document.getElementById('btnLoad');
            if (loadBtn) {
                loadBtn.replaceWith(loadBtn.cloneNode(true));
                document.getElementById('btnLoad').addEventListener('click', loadSummary);
            } else {
                console.warn("[AMANICARE] btnLoad not found");
            }

            // run once on load
            window.addEventListener('load', () => {
                setTimeout(() => {
                    try { loadSummary(); } catch (e) { console.error("[AMANICARE] initial load failed:", e); }
                }, 300);
            });

            // expose for debugging
            window.__AMANICARE = { loadSummary, renderTable, renderChart, loadClinic, renderLatestExplanation };
        })();
    </script>

</body>

</html>